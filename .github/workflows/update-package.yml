name: Update Package
on:
  workflow_dispatch:
    inputs:
      name:
        required: true
        description: "Package name (e.g., caesura)"
      version:
        required: true
        description: "Version to update to (e.g., 0.27.0)"
      repo:
        required: false
        description: "Source repository (defaults to RogueOneEcho/<name>)"

jobs:
  update:
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v4

    - uses: cachix/install-nix-action@v27
      with:
        nix_path: nixpkgs=channel:nixos-unstable

    - name: Update package
      run: |
        chmod +x scripts/update-package.sh
        ./scripts/update-package.sh \
          "${{ inputs.name }}" \
          "${{ inputs.version }}" \
          "${{ inputs.repo || format('RogueOneEcho/{0}', inputs.name) }}"

    - name: Commit and push
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update ${{ inputs.name }} to ${{ inputs.version }}"
          git push
        fi
